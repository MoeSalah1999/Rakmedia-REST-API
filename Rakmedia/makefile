# ----------------------------------------
# Makefile for Django Production Project
# ----------------------------------------
# Author: Moe Salah
# Description:
#   This Makefile provides convenient shortcuts
#   for managing the Django application, Docker, testing,
#   environment setup, and deployment tasks.
# ----------------------------------------

# Variables
PROJECT_NAME=task_management_system
DOCKER_IMAGE=$(PROJECT_NAME):latest
DOCKER_COMPOSE_FILE=docker-compose.yml
ENV_FILE=.env
PYTHON=python
MANAGE=$(PYTHON) manage.py

# ========================================
# ENVIRONMENT SETUP
# ========================================

.PHONY: install
install:
	@echo "Installing dependencies..."
	pip install --upgrade pip
	pip install -r requirements.txt
	@echo "âœ… Dependencies installed successfully."

.PHONY: makemigrations
makemigrations:
	@echo "ğŸ”§ Creating new migrations..."
	$(MANAGE) makemigrations
	@echo "âœ… Migrations created."

.PHONY: migrate
migrate:
	@echo "ğŸ“¦ Applying migrations..."
	$(MANAGE) migrate
	@echo "âœ… Database migrated successfully."

.PHONY: createsuperuser
createsuperuser:
	@echo "ğŸ‘‘ Creating superuser..."
	$(MANAGE) createsuperuser

.PHONY: collectstatic
collectstatic:
	@echo "ğŸ“ Collecting static files..."
	$(MANAGE) collectstatic --noinput
	@echo "âœ… Static files collected."

.PHONY: shell
shell:
	@echo "ğŸš Opening Django shell..."
	$(MANAGE) shell

# ========================================
# SERVER COMMANDS
# ========================================

.PHONY: run
run:
	@echo "ğŸš€ Running development server..."
	$(MANAGE) runserver 0.0.0.0:8000

.PHONY: run-prod
run-prod:
	@echo "ğŸš€ Running Django in production mode..."
	DJANGO_SETTINGS_MODULE=project.settings.prod $(MANAGE) runserver 0.0.0.0:8000

.PHONY: worker
worker:
	@echo "âš™ï¸  Running Django Q worker..."
	$(MANAGE) qcluster

# ========================================
# TESTING & QUALITY
# ========================================

.PHONY: test
test:
	@echo "ğŸ§ª Running unit tests..."
	$(MANAGE) test
	@echo "âœ… All tests passed."

.PHONY: lint
lint:
	@echo "ğŸ§¹ Linting code with flake8..."
	flake8 --max-line-length=100 .
	@echo "âœ… Linting completed."

.PHONY: format
format:
	@echo "âœ¨ Formatting code with black..."
	black .
	@echo "âœ… Code formatted."

.PHONY: coverage
coverage:
	@echo "ğŸ“Š Running test coverage report..."
	coverage run manage.py test
	coverage report -m
	coverage html
	@echo "âœ… Coverage report generated (see htmlcov/index.html)."

# ========================================
# DOCKER COMMANDS
# ========================================

.PHONY: docker-build
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(DOCKER_IMAGE) .
	@echo "âœ… Docker image built successfully."

.PHONY: docker-up
docker-up:
	@echo "ğŸ³ Starting Docker containers..."
	docker-compose -f $(DOCKER_COMPOSE_FILE) up -d
	@echo "âœ… Containers started."

.PHONY: docker-down
docker-down:
	@echo "ğŸ§¹ Stopping Docker containers..."
	docker-compose -f $(DOCKER_COMPOSE_FILE) down
	@echo "âœ… Containers stopped."

.PHONY: docker-logs
docker-logs:
	@echo "ğŸ“œ Showing Docker logs..."
	docker-compose logs -f

.PHONY: docker-prune
docker-prune:
	@echo "ğŸ§½ Cleaning up Docker resources..."
	docker system prune -af
	@echo "âœ… Docker cleaned."

# ========================================
# DATABASE UTILITIES
# ========================================

.PHONY: dbshell
dbshell:
	@echo "ğŸ˜ Opening PostgreSQL shell..."
	$(MANAGE) dbshell

.PHONY: dumpdata
dumpdata:
	@echo "ğŸ’¾ Dumping data to fixtures.json..."
	$(MANAGE) dumpdata --indent 2 > fixtures.json
	@echo "âœ… Data dumped successfully."

.PHONY: loaddata
loaddata:
	@echo "ğŸ“¥ Loading data from fixtures.json..."
	$(MANAGE) loaddata fixtures.json
	@echo "âœ… Data loaded successfully."

# ========================================
# DEPLOYMENT & CLEANUP
# ========================================

.PHONY: clean
clean:
	@echo "ğŸ§¹ Cleaning up pycache and temp files..."
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	@echo "âœ… Project cleaned."

.PHONY: resetdb
resetdb:
	@echo "âš ï¸ Resetting database..."
	$(MANAGE) flush --no-input
	$(MAKE) migrate
	@echo "âœ… Database reset."

.PHONY: help
help:
	@echo "ğŸ“˜ Available Make commands:"
	@grep '^[a-zA-Z_-]\+:' Makefile | sed 's/:.*//'
